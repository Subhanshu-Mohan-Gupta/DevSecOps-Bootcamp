apiVersion: litmuschaos.io/v1alpha1
kind: ChaosExperiment
metadata:
  name: network-blackhole
  namespace: demo
  labels:
    name: network-blackhole
    app.kubernetes.io/part-of: litmus
    app.kubernetes.io/component: chaosexperiment
spec:
  definition:
    scope: Namespaced
    permissions:
      - apiGroups: [""]
        resources: ["pods"]
        verbs: ["list","get","patch","update"]
      - apiGroups: [""]
        resources: ["pods/exec"]
        verbs: ["get","list","create"]
      - apiGroups: [""]
        resources: ["events"]
        verbs: ["create"]
    image: "ubuntu:20.04"
    imagePullPolicy: Always
    args:
    - -c
    - |
      apt-get update && apt-get install -y curl iptables iproute2
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      chmod +x kubectl && mv kubectl /usr/local/bin/
      echo "Starting network blackhole simulation"
      TARGET_POD=$(kubectl get pods -l app=nginx -n demo -o jsonpath='{.items[0].metadata.name}')
      echo "Simulating network issues on pod: $TARGET_POD"
      kubectl annotate pods -l app=nginx network.blackhole.active=true -n demo --overwrite
      sleep ${TOTAL_CHAOS_DURATION:-30}
      kubectl annotate pods -l app=nginx network.blackhole.active- -n demo
      echo "Network blackhole simulation completed"
    command:
    - /bin/bash
    env:
    - name: TOTAL_CHAOS_DURATION
      value: '30'
    labels:
      name: network-blackhole

